<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; padding: 20px; background-color: #f5f5f5; margin:0; }
        
        /* ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡πâ‡∏ß‡∏¢ JS */
        #section-bmi { display: block; } 
        #section-bp { display: none; }
        #section-summary { display: none; }

        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { text-align: center; margin-top: 0; }
        
        button { width: 100%; padding: 15px; border: none; border-radius: 50px; font-size: 18px; color: white; margin-top: 20px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        button:disabled { background-color: #ccc !important; cursor: not-allowed; }
        
        .btn-green { background-color: #28a745; }
        .btn-pink { background-color: #e83e8c; }
        
        input { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        label { display: block; margin-top: 15px; font-weight: bold; }

        #status-msg { text-align: center; color: #666; font-size: 12px; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="section-bmi" class="card">
        <h2 style="color: #28a745;">üèãÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å BMI</h2>
        <label>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (kg)</label>
        <input type="number" id="weight" placeholder="00.0">
        <label>‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (cm)</label>
        <input type="number" id="height" placeholder="000">
        <button class="btn-green" onclick="sendData('bmi')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å BMI</button>
    </div>

    <div id="section-bp" class="card">
        <h2 style="color: #e83e8c;">‚ù§Ô∏è ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï</h2>
        <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ö‡∏ô (SYS)</label>
        <input type="number" id="sys" placeholder="120">
        <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á (DIA)</label>
        <input type="number" id="dia" placeholder="80">
        <label>‡∏ä‡∏µ‡∏û‡∏à‡∏£ (Pulse)</label>
        <input type="number" id="pulse" placeholder="75">
        <button class="btn-pink" onclick="sendData('bp')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô</button>
    </div>

    <div id="section-summary" class="card" style="text-align: center;">
        <h2 style="color: #007bff;">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</h2>
        <p>‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á...</p>
    </div>

    <div id="status-msg">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE...</div>

    <script>
        // ==========================================
        // ‚ö†Ô∏è ‡πÄ‡∏ä‡πá‡∏Ñ ID ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        const LIFF_ID = "2008799065-MIMzWyU2"; 
        
        // ‚ö†Ô∏è ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£ Deploy Google Script ‡πÉ‡∏´‡∏°‡πà ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÄ‡∏≠‡∏≤ URL ‡πÉ‡∏´‡∏°‡πà‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö!
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxH-L9hC1ta73oyBt0VeXWloEWt4sgBC7y--iVsql51dcUJOeJFKfEg0pO6nBDGxGpj/exec";
        // ==========================================

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        function showSection(sectionId) {
            document.getElementById('section-bmi').style.display = 'none';
            document.getElementById('section-bp').style.display = 'none';
            document.getElementById('section-summary').style.display = 'none';
            document.getElementById(sectionId).style.display = 'block';
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        async function main() {
            try {
                await liff.init({ liffId: LIFF_ID });
                document.getElementById('status-msg').innerText = "‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‚úÖ";
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                }

                // ‡πÄ‡∏ä‡πá‡∏Ñ URL ‡∏ß‡πà‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏´‡∏ô (?page=...)
                const queryString = window.location.search;
                const urlParams = new URLSearchParams(queryString);
                const page = urlParams.get('page');

                if (page === 'bp') showSection('section-bp');
                else if (page === 'summary') showSection('section-summary');
                else showSection('section-bmi');

            } catch (err) {
                document.getElementById('status-msg').innerText = "Error: " + err;
            }
        }
        main();

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô)
        async function sendData(type) {
            // 1. ‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡πÄ‡∏ö‡∏¥‡πâ‡∏•)
            const allButtons = document.querySelectorAll('button');
            allButtons.forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = "0.6";
                btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...";
            });

            try {
                const profile = await liff.getProfile();
                
                // ‚úÖ ‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠ displayName ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
                let data = { 
                    userId: profile.userId, 
                    displayName: profile.displayName, 
                    type: type 
                };
                
                let summaryMessage = "";

                // ==========================================
                // üü¢ ‡∏Å‡∏£‡∏ì‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å BMI
                // ==========================================
                if(type === 'bmi') {
                    let wInput = document.getElementById('weight').value;
                    let hInput = document.getElementById('height').value;

                    // Validation: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á
                    if(wInput === "" || hInput === "") throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á");
                    
                    let w = parseFloat(wInput);
                    let h = parseFloat(hInput);

                    // Validation: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ
                    if(w <= 0 || h <= 0) throw new Error("‡∏Ñ‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0");
                    if(h < 50 || h > 300) throw new Error("‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥");

                    data.weight = w;
                    data.height = h;

                    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì BMI ‡πÇ‡∏ä‡∏ß‡πå‡∏™‡∏î‡πÜ
                    let bmi = w / Math.pow(h/100, 2);
                    let status = "‡∏õ‡∏Å‡∏ï‡∏¥";
                    if (bmi < 18.5) status = "‡∏ú‡∏≠‡∏°";
                    else if (bmi >= 23 && bmi < 25) status = "‡∏ó‡πâ‡∏ß‡∏°";
                    else if (bmi >= 25 && bmi < 30) status = "‡∏≠‡πâ‡∏ß‡∏ô";
                    else if (bmi >= 30) status = "‡∏≠‡πâ‡∏ß‡∏ô‡∏°‡∏≤‡∏Å";

                    summaryMessage = `üìä BMI ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n----------------\n‡∏ô‡∏ô: ${w} | ‡∏™‡∏π‡∏á: ${h}\nBMI: ${bmi.toFixed(2)}\n‡∏ú‡∏•: ${status}`;
                } 
                
                // ==========================================
                // üî¥ ‡∏Å‡∏£‡∏ì‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô
                // ==========================================
                else if(type === 'bp') {
                    let sysInput = document.getElementById('sys').value;
                    let diaInput = document.getElementById('dia').value;
                    let pulseInput = document.getElementById('pulse').value;

                    // Validation
                    if(sysInput === "" || diaInput === "" || pulseInput === "") throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á");

                    let sys = parseInt(sysInput);
                    let dia = parseInt(diaInput);
                    let pulse = parseInt(pulseInput);

                    if(sys <= 0 || dia <= 0 || pulse <= 0) throw new Error("‡∏Ñ‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0");
                    if(sys > 300 || dia > 200) throw new Error("‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á");

                    data.sys = sys;
                    data.dia = dia;
                    data.pulse = pulse;

                    // ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏™‡∏î‡πÜ
                    let bpStatus = "‡∏õ‡∏Å‡∏ï‡∏¥ üü¢";
                    if (sys >= 140 || dia >= 90) bpStatus = "‡∏™‡∏π‡∏á (‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á) üî¥";
                    else if (sys >= 130 || dia >= 85) bpStatus = "‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á üü†";
                    else if (sys < 90 || dia < 60) bpStatus = "‡∏ï‡πà‡∏≥ üü°";

                    summaryMessage = `‚ù§Ô∏è ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n----------------\nBP: ${sys}/${dia}\n‡∏ä‡∏µ‡∏û‡∏à‡∏£: ${pulse}\n‡∏ú‡∏•: ${bpStatus}`;
                }

                // 2. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Sheets
                document.getElementById('status-msg').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
                
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                // 3. ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                alert(summaryMessage);
                liff.closeWindow();

            } catch (err) {
                // ‚ùå ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Error ‡πÉ‡∏´‡πâ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏∏‡πà‡∏°
                alert("‚ö†Ô∏è " + err.message);
                
                allButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.style.opacity = "1";
                    btn.innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
                });
                document.getElementById('status-msg').innerText = "";
            }
        }
    </script>
</body>
</html>